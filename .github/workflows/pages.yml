name: Deploy Demo & Docs to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libportaudio2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pdoc

      - name: Generate API documentation
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pdoc signal_processing generate_audio \
            --docformat numpy \
            -o site/docs

      - name: Copy demo app
        run: cp -r demo site/demo

      - name: Create landing page
        run: |
          cat > site/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Doppler Velocity Analyzer</title>
            <style>
              :root{--primary:#2c3e50;--accent:#3498db;--bg:#f5f6fa;--card:#fff;--green:#27ae60;}
              *{margin:0;padding:0;box-sizing:border-box;}
              body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
                   background:var(--bg);color:var(--primary);line-height:1.6;}
              .container{max-width:900px;margin:0 auto;padding:40px 20px;}
              h1{font-size:2.2rem;margin-bottom:8px;}
              .subtitle{color:#7f8c8d;font-size:1.1rem;margin-bottom:32px;}
              .card{background:var(--card);border-radius:12px;padding:28px;
                    box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:24px;}
              .card h2{font-size:1.3rem;margin-bottom:12px;color:var(--accent);}
              .card ul{padding-left:20px;} .card li{margin-bottom:6px;}
              a{color:var(--accent);text-decoration:none;} a:hover{text-decoration:underline;}
              code{background:#ecf0f1;padding:2px 6px;border-radius:4px;font-size:.9em;}
              pre{background:#2c3e50;color:#ecf0f1;padding:16px;border-radius:8px;
                  overflow-x:auto;margin:12px 0;}
              .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
              @media(max-width:640px){.grid{grid-template-columns:1fr;}}
              .badge{display:inline-block;padding:4px 12px;border-radius:20px;
                     font-size:.85em;font-weight:600;margin-right:8px;margin-bottom:8px;}
              .badge-py{background:#3572A5;color:#fff;}
              .badge-dash{background:#119DFF;color:#fff;}
              .badge-fft{background:#27ae60;color:#fff;}
              .demo-btn{display:inline-block;background:var(--green);color:#fff;
                        padding:14px 32px;border-radius:8px;font-size:1.1em;font-weight:600;
                        text-decoration:none;margin-top:12px;transition:background .2s;}
              .demo-btn:hover{background:#219a52;text-decoration:none;color:#fff;}
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Doppler Velocity Analyzer</h1>
              <p class="subtitle">Real-time velocity measurement using the acoustic Doppler effect</p>

              <div class="card" style="text-align:center;">
                <span class="badge badge-py">Python</span>
                <span class="badge badge-dash">Dash / Web Audio</span>
                <span class="badge badge-fft">FFT</span>
                <h2>Live Demo</h2>
                <p>Run the Doppler analyzer directly in your browser — no installation needed.<br>
                   Uses the Web Audio API for microphone access and real-time FFT analysis.</p>
                <a class="demo-btn" href="demo/">Launch Demo</a>
              </div>

              <div class="grid">
                <div class="card">
                  <h2>Local Setup (Python)</h2>
                  <pre>pip install -r requirements.txt
          python generate_audio.py
          python doppler_analyzer.py</pre>
                  <p>Then open <code>http://localhost:8050</code></p>
                </div>
                <div class="card">
                  <h2>API Documentation</h2>
                  <ul>
                    <li><a href="docs/signal_processing.html">signal_processing</a> — DSP algorithms</li>
                    <li><a href="docs/generate_audio.html">generate_audio</a> — Audio generator</li>
                  </ul>
                </div>
              </div>

              <div class="card">
                <h2>Project Files</h2>
                <ul>
                  <li><code>doppler_analyzer.py</code> — Main app with Dash web UI</li>
                  <li><code>signal_processing.py</code> — Core FFT-based Doppler analysis (student-editable)</li>
                  <li><code>generate_audio.py</code> — Audio file generator (GUI / CLI)</li>
                  <li><code>requirements.txt</code> — Python dependencies</li>
                </ul>
              </div>

              <div class="card">
                <h2>Theory</h2>
                <p>For small velocities (<em>v &#8810; c</em>):</p>
                <pre>v = &#916;f &#215; c / f</pre>
                <p>where &#916;f is the frequency shift, c = 343 m/s, and f is the carrier frequency.</p>
              </div>
            </div>
          </body>
          </html>
          HTMLEOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
